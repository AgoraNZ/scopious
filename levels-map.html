<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Debug Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body { margin:0; padding:0; height:100% }
    #map { width:100%; height:100% }
    .factory-icon { width:32px; height:32px; background-size:cover; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
  <script>
    // 1) Set up map
    const map = L.map('map').setView([-42, 173], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'Â© OpenStreetMap'
    }).addTo(map);

    // 2) Define factories
    const factories = {
      westland: {
        name: 'Westland Milk Products',
        coords: [-42.7208, 170.9795],
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/4/4a/Westland_Milk_Products_dairy_processing_plant.jpg'
      },
      ofi: {
        name: 'OFI Tokoroa',
        coords: [-38.1667, 175.8667],
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/OFI_Milking_factory_tokoroa.jpg/320px-OFI_Milking_factory_tokoroa.jpg'
      }
    };

    let farmMarkers = L.layerGroup().addTo(map);

    // 3) Utility to generate random farms within 100km of a point
    function randomFarms(center, count=50) {
      const farms = [];
      for (let i=0; i<count; i++) {
        // generate a random bearing & distance up to 100km
        const angle = Math.random()*2*Math.PI;
        const dist = Math.random()*100000; // meters
        // offset lat/lng by roughly dist/111000 deg and cos(lat)
        const dLat = (dist*Math.cos(angle)) / 111000;
        const dLng = (dist*Math.sin(angle)) / (111000*Math.cos(center[0]*Math.PI/180));
        farms.push([ center[0]+dLat, center[1]+dLng ]);
      }
      return farms;
    }

    // 4) Place factory markers and attach click handlers
    Object.entries(factories).forEach(([key, f])=>{
      const icon = L.divIcon({
        className: 'factory-icon',
        html: `<div style="
                background-image:url(${f.iconUrl});
                width:100%; height:100%;
              "></div>`
      });
      const mk = L.marker(f.coords, {icon}).addTo(map);
      mk.bindPopup(`<strong>${f.name}</strong>`);
      mk.on('click', ()=> {
        // clear existing farms
        farmMarkers.clearLayers();
        // generate & add new farm markers
        const farms = randomFarms(f.coords, 50);
        farms.forEach((latlng, idx) => {
          L.marker(latlng)
           .bindTooltip(`#${10000+idx}`, {permanent:false})
           .addTo(farmMarkers);
        });
      });
    });
  </script>
</body>
</html>
