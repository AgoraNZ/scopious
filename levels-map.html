<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vat Levels & Route Planner</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Geocoder CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    crossorigin=""
  />
  <!-- Routing Machine CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    crossorigin=""
  />

  <style>
    body, html { margin:0; padding:0; height:100% }
    #map { width:100%; height:100% }

    #route-controls {
      position:absolute; top:10px; right:10px;
      background:rgba(34,34,34,0.9);
      padding:12px; border-radius:6px;
      color:#f5f5f5; width:260px;
      font-size:0.9rem; z-index:1000;
    }
    #route-controls label { display:block; margin-top:8px }
    #route-controls select,
    #route-controls input {
      width:100%; padding:6px; margin-top:4px;
      border:none; border-radius:4px;
      background:#2c2c2c; color:#f5f5f5;
    }
    #route-controls button {
      width:100%; padding:8px; margin-top:8px;
      border:none; border-radius:4px;
      background:#3498db; color:#fff;
      cursor:pointer;
    }
    #route-summary {
      margin-top:12px; max-height:200px;
      overflow:auto; background:#1b1b1b;
      padding:8px; border-radius:4px;
    }
    .farm-tooltip {
      background:#fff!important;
      color:#000!important;
      font-size:0.8rem;
    }
    .factory-icon {
      width:32px; height:32px;
      border:2px solid #fff; border-radius:4px;
      background-size:cover;
    }
  </style>
</head>
<body>
  <div id="route-controls">
    <label>Factory Start:</label>
    <select id="factorySelect">
      <option value="">Select Factory…</option>
      <option value="westland">Westland Milk Products (Hokitika)</option>
      <option value="ofi">OFI Milk Factory (Tokoroa)</option>
    </select>

    <label>Tanker Capacity (L):</label>
    <input type="number" id="tankerCapacity" value="30000"/>

    <label>Trailer Capacity (L):</label>
    <input type="number" id="trailerCapacity" value="20000"/>

    <button id="planRouteBtn">Plan Route</button>

    <div id="route-summary">
      <strong>Summary:</strong>
      <div id="summaryText">—</div>
      <div id="etaText"></div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
  <!-- Geocoder -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" crossorigin=""></script>
  <!-- Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js" crossorigin=""></script>
  <!-- MovingMarker -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-moving-marker@2.0.0/MovingMarker.min.js" crossorigin=""></script>

  <script>
    // 1) Define factory locations + icons
    const factories = {
      westland: {
        name: 'Westland Milk Products',
        coords: L.latLng(-42.7208, 170.9795), // 42°43′15″S,170°58′46″E :contentReference[oaicite:0]{index=0}
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/4/4a/Westland_Milk_Products_dairy_processing_plant.jpg'
      },
      ofi: {
        name: 'OFI Milk Factory',
        coords: L.latLng(-38.1667, 175.8667), // Tokoroa approximate center :contentReference[oaicite:1]{index=1}
        iconUrl: 'https://www.ofi.com/content/dam/olamofi/products-and-ingredients/dairy/dairy-pdfs/ofi-dairytracks-report-final.pdf' // placeholder
      }
    };

    // 2) Sample 500 random NZ-wide points, filter later
    const allSamples = [];
    for (let i=0; i<500; i++){
      // NZ approx bounding box
      const lat = -47 + Math.random()*13;  // -47 to -34
      const lng = 166 + Math.random()*13;  // 166 to 179
      allSamples.push({lat,lng,
        vats: [Math.floor(2000+Math.random()*18000)]});
    }

    // 3) Initialize map
    const map = L.map('map').setView([-42,173],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);

    let factoryLayer, farmLayer, routeControl, movingMarker, startCoords;

    // 4) Factory selection handler
    document.getElementById('factorySelect')
      .addEventListener('change', e => {
        const val = e.target.value;
        if (factoryLayer) map.removeLayer(factoryLayer);
        if (farmLayer) map.removeLayer(farmLayer);
        if (routeControl) map.removeControl(routeControl);
        if (movingMarker) map.removeLayer(movingMarker);
        document.getElementById('summaryText').innerText = '—';
        document.getElementById('etaText').innerText = '';

        if (!val) return;
        const f = factories[val];
        startCoords = f.coords;

        // Add factory marker
        const facIcon = L.divIcon({
          className:'factory-icon',
          html:`<div style="
            background-image:url(${f.iconUrl});
            width:100%;height:100%;
            background-size:cover;
          "></div>`
        });
        factoryLayer = L.marker(f.coords,{icon:facIcon}).addTo(map)
          .bindPopup(`<strong>${f.name}</strong>`);

        map.setView(f.coords,9);

        // Filter farms within 100km
        const farms = allSamples
          .filter(s => s.vats && startCoords.distanceTo([s.lat,s.lng])<=100000)
          .map((s,i)=>({
            supplier: String(10000+i),
            vats: s.vats,
            coords: L.latLng(s.lat,s.lng)
          }));

        // Plot farm markers
        farmLayer = L.layerGroup(farms.map(fm=>{
          const m = L.marker(fm.coords).addTo(map);
          m.bindTooltip(
            `<strong>#${fm.supplier}</strong><br>` +
            `Vat: ${fm.vats[0].toLocaleString()} L`,
            {direction:'right',className:'farm-tooltip'}
          );
          return m;
        }));
      });

    // 5) Nearest-neighbor helper
    function selectStops(cap, candidates){
      let rem = cap, cur = startCoords;
      const seq = [], pool = candidates.slice();
      while (true) {
        pool.forEach(f=>f.dist=cur.distanceTo(f.coords));
        pool.sort((a,b)=>a.dist-b.dist);
        const idx = pool.findIndex(f=>f.vats[0]<=rem);
        if (idx<0) break;
        const nxt = pool.splice(idx,1)[0];
        seq.push(nxt);
        rem -= nxt.vats[0];
        cur = nxt.coords;
      }
      return {seq, collected:cap-rem, remaining:rem};
    }

    // 6) Plan route
    document.getElementById('planRouteBtn').onclick = ()=>{
      if (!startCoords) return alert('Select a factory first');
      const truckCap = +document.getElementById('tankerCapacity').value;
      const trailCap = +document.getElementById('trailerCapacity').value;

      // Gather current farms from farmLayer
      const farms = [];
      farmLayer.eachLayer(m => {
        const latlng = m.getLatLng();
        farms.push({coords:latlng,vats:[0]}); // vats unused here
      });

      const {seq:truckStops} = selectStops(truckCap, farms);
      const left = farms.filter(f=>!truckStops.includes(f));
      const {seq:trailStops} = selectStops(trailCap, left);

      const allStops = [...truckStops,...trailStops];
      const waypoints = [
        startCoords,
        ...allStops.map(f=>f.coords),
        startCoords
      ];

      if (routeControl) map.removeControl(routeControl);
      if (movingMarker) map.removeLayer(movingMarker);

      routeControl = L.Routing.control({
        waypoints, showAlternatives:false, routeWhileDragging:false
      }).addTo(map);

      routeControl.on('routesfound', e => {
        const route = e.routes[0];
        const coords = route.coordinates;
        const ms = route.summary.totalTime*1000;
        movingMarker = L.Marker.movingMarker(coords, ms, {autostart:true})
          .addTo(map)
          .on('end', ()=>{
            document.getElementById('etaText').innerHTML='<strong>Arrived</strong>';
          });
        const eta = new Date(Date.now()+route.summary.totalTime*1000)
          .toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        document.getElementById('etaText').innerHTML=`<strong>ETA:</strong> ${eta}`;
      });
    };
  </script>
</body>
</html>
