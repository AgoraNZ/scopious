<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dairy Farm Alerts Overview</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --header-bg: #2c2c2c;
      --row-hover: #333;
      --text: #f5f5f5;
      --ok: #2ecc71;
      --warning: #f39c12;
      --info: #3498db;
      --critical: #e74c3c;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family:sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container {
      max-width:960px; margin:20px auto; padding:0 16px;
    }
    h1 { margin-bottom:12px; }

    /* Summary */
    .summary table {
      width:100%; border-collapse:collapse; margin-bottom:20px;
    }
    .summary thead { background:var(--header-bg); }
    .summary th, .summary td {
      padding:8px; font-size:0.9rem;
      text-align:left; color:var(--text);
      border-bottom:1px solid #444;
    }

    /* Add Farm */
    .add-farm-btn { margin-bottom:12px; }
    .add-farm-btn button {
      padding:8px 12px; background:#3498db;
      border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }
    #addFarmForm {
      display:none; background:#222;
      border:1px solid #444; padding:12px;
      border-radius:6px; margin-bottom:16px;
    }
    #addFarmForm label {
      display:block; margin-bottom:6px; color:var(--text);
    }
    #addFarmForm input[type="text"] {
      width:100%; padding:6px; border:1px solid #555;
      background:#333; color:var(--text);
      border-radius:4px; margin-bottom:12px;
    }
    .alarms-list {
      display:grid; grid-template-columns:1fr 1fr;
      gap:4px; margin-bottom:12px;
    }
    .alarms-list label {
      display:flex; align-items:center;
      font-size:0.9rem;
    }
    .alarms-list input { margin-right:6px; }
    #addFarmForm .buttons {
      text-align:right;
    }
    #addFarmForm .buttons button {
      padding:6px 10px; margin-left:8px;
      border:none; border-radius:4px; cursor:pointer;
      background:#3498db; color:#fff;
    }

    /* Search & table */
    .search { margin-bottom:12px; }
    .search input {
      width:100%; padding:8px 12px;
      border:none; border-radius:4px;
      background:#2c2c2c; color:var(--text);
    }
    table.overview {
      width:100%; border-collapse:collapse;
    }
    thead.overview { background:var(--header-bg); }
    th.overview, td.overview {
      padding:10px; text-align:left;
      font-size:0.95rem; color:var(--text);
      border-bottom:1px solid #444;
    }
    tbody.overview tr:hover {
      background:var(--row-hover);
    }
    .dot {
      display:inline-block; width:10px; height:10px;
      border-radius:50%; margin-right:6px;
      vertical-align:middle;
    }
    .status-ok       .dot { background:var(--ok); }
    .status-warning  .dot { background:var(--warning); }
    .status-info     .dot { background:var(--info); }
    .status-critical .dot { background:var(--critical); }
    table.overview a {
      color:var(--text)!important;
      text-decoration:none;
      display:block; width:100%; height:100%;
    }
    td.comment, td.ticket { min-width:120px; }
    td.actions button {
      padding:4px 8px; background:#3498db;
      border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }

    /* Footer */
    .footer-btn {
      text-align:center; margin-top:20px;
    }
    .footer-btn button {
      padding:10px 20px; font-size:1rem;
      border:none; border-radius:4px;
      background:#3498db; color:#fff;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dairy Farm Alerts Overview</h1>

    <!-- Summary -->
    <div class="summary">
      <table>
        <thead>
          <tr>
            <th>Organisation Name</th>
            <th>Organisation Status</th>
            <th>Total Gateways</th>
            <th>Total Devices</th>
            <th>Active Devices</th>
            <th>Inactive Devices</th>
          </tr>
        </thead>
        <tbody id="summary-body"></tbody>
      </table>
    </div>

    <!-- Add Farm -->
    <div class="add-farm-btn">
      <button id="showAddForm">Add Farm</button>
    </div>
    <div id="addFarmForm">
      <label>Supplier Number:
        <input type="text" id="newSupplier" placeholder="e.g. 12345"/>
      </label>
      <label>Farm Name:
        <input type="text" id="newFarmName" placeholder="e.g. J Block"/>
      </label>
      <div>
        <span>Assign Alarms:</span>
        <div class="alarms-list" id="alarmsCheckboxes"></div>
      </div>
      <div class="buttons">
        <button id="cancelAdd">Cancel</button>
        <button id="saveAdd">Save</button>
      </div>
    </div>

    <!-- Search -->
    <div class="search">
      <input id="search" placeholder="🔍 Filter by supplier number…"/>
    </div>

    <!-- Overview Table -->
    <table class="overview">
      <thead class="overview">
        <tr>
          <th class="overview">Supplier #</th>
          <th class="overview">Farm Name</th>
          <th class="overview">Status</th>
          <th class="overview">Alarm Name</th>
          <th class="overview">Time Triggered</th>
          <th class="overview">Ticket</th>
          <th class="overview">Actions</th>
        </tr>
      </thead>
      <tbody id="overview-body"></tbody>
    </table>

    <!-- Create Rule -->
    <div class="footer-btn">
      <button onclick="location.href='rules.html'">
        Create Alarm / Rule
      </button>
    </div>
  </div>

  <script>
    // Alarm types
    const ALARMS = [
      'Milk Collection','Plate Cooler Fault',
      'Vat Chiller Compressor Fault','Agitator Fault',
      'Vat Hot Wash','Battery Low Alarm',
      'Chiller Condition','temperature fault'
    ];

    // Pre-configured alert history
    const historyCfg = {
      '12345':{criticalOn:null,warningOn:null},
      '52440':{criticalOn:null,warningOn:null},
      '44074':{criticalOn:'2025-05-06 05:39',warningOn:null},
      '35421':{criticalOn:null,warningOn:null},
      '98765':{criticalOn:null,warningOn:'2025-05-04 10:30'},
      '24680':{criticalOn:null,warningOn:null},
      '13579':{criticalOn:null,warningOn:null},
      '11223':{criticalOn:null,warningOn:null},
      '99887':{criticalOn:'2025-04-30 12:50',warningOn:null},
      '55678':{criticalOn:null,warningOn:null}
    };

    // LocalStorage keys
    const LS_FARMS   = 'farms';
    const LS_TICKETS = 'tickets';

    // load/save farms
    function loadFarms(){
      const stored = localStorage.getItem(LS_FARMS);
      if(stored) return JSON.parse(stored);
      const initial = Object.keys(historyCfg).map(s=>({
        supplier:s,name:'',activeAlarms:[...ALARMS]
      }));
      localStorage.setItem(LS_FARMS, JSON.stringify(initial));
      return initial;
    }
    function saveFarms(arr){
      localStorage.setItem(LS_FARMS, JSON.stringify(arr));
    }

    // load/save tickets
    function loadTickets(){
      return JSON.parse(localStorage.getItem(LS_TICKETS) || '[]');
    }
    function saveTickets(arr){
      localStorage.setItem(LS_TICKETS, JSON.stringify(arr));
    }

    let farmsList = loadFarms();
    let tickets   = loadTickets();

    // render summary (one row)
    function renderSummary(){
      const sb = document.getElementById('summary-body');
      const gateways = farmsList.length;
      const devices  = gateways * 4;
      sb.innerHTML = `
        <tr>
          <td>All Farms</td>
          <td>Active</td>
          <td>${gateways}</td>
          <td>${devices}</td>
          <td>${devices}</td>
          <td>0</td>
        </tr>
      `;
    }
    renderSummary();

    // build overview data
    function makeOverview(f){
      const cfg = historyCfg[f.supplier]||{};
      let status='Ok', alarm='', time='';
      if(cfg.criticalOn){
        status='Critical'; alarm='temperature fault'; time=cfg.criticalOn;
      } else if(cfg.warningOn){
        status='Warning'; alarm='Battery Low Alarm'; time=cfg.warningOn;
      }
      return {...f,status,alarm,time};
    }
    let overviewData = farmsList
      .map(makeOverview)
      .sort((a,b)=>{
        const sev={'Critical':3,'Warning':2,'Info':1,'Ok':0};
        return sev[b.status]-sev[a.status];
      });

    // render overview
    function renderOverview(rows){
      const tb = document.getElementById('overview-body');
      tb.innerHTML = '';
      rows.forEach(r=>{
        // find ticket for this alert
        const tk = tickets.find(t=>
          t.supplier===r.supplier && t.alertTime===r.time
        );
        let ticketCell = '';
        if(r.status==='Critical'){
          if(!tk){
            ticketCell = `<button onclick="
              location.href='ticket.html?
              supplier=${r.supplier}&
              alertTime=${encodeURIComponent(r.time)}'
            ">Open Ticket</button>`;
          } else if(!tk.closeTime){
            ticketCell = `<button onclick="
              location.href='ticket.html?
              supplier=${r.supplier}&
              alertTime=${encodeURIComponent(r.time)}'
            ">View Ticket</button>`;
          } else {
            ticketCell = `Closed: ${tk.closeTime}`;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <a href="dashboard.html?supplier=${r.supplier}">
              ${r.supplier}
            </a>
          </td>
          <td>${r.name}</td>
          <td class="status-${r.status.toLowerCase()}">
            <a href="alarm.html?supplier=${r.supplier}">
              <span class="dot"></span>${r.status}
            </a>
          </td>
          <td>
            <a href="alarm.html?supplier=${r.supplier}">
              ${r.alarm}
            </a>
          </td>
          <td>
            <a href="alarm.html?supplier=${r.supplier}">
              ${r.time}
            </a>
          </td>
          <td class="ticket">${ticketCell}</td>
          <td class="actions">
            <button onclick="location.href='setup.html?supplier=${r.supplier}'">
              Edit
            </button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
    renderOverview(overviewData);

    // search filter
    document.getElementById('search')
      .addEventListener('input', e=>{
        const q=e.target.value.trim();
        renderOverview(
          overviewData.filter(r=>r.supplier.includes(q))
        );
      });

    // Add Farm form logic
    const showBtn     = document.getElementById('showAddForm');
    const formDiv     = document.getElementById('addFarmForm');
    const cancelBtn   = document.getElementById('cancelAdd');
    const saveBtn     = document.getElementById('saveAdd');
    const alarmChkDiv = document.getElementById('alarmsCheckboxes');

    showBtn.onclick = ()=>{
      formDiv.style.display='block';
      alarmChkDiv.innerHTML='';
      ALARMS.forEach(name=>{
        const id = `chk_${name.replace(/\s+/g,'')}`;
        alarmChkDiv.innerHTML += `
          <label>
            <input type="checkbox" id="${id}" value="${name}" checked/>
            ${name}
          </label>`;
      });
    };
    cancelBtn.onclick = ()=> formDiv.style.display='none';

    saveBtn.onclick = ()=>{
      const sup = document.getElementById('newSupplier').value.trim();
      const nm  = document.getElementById('newFarmName').value.trim();
      if(!sup){ alert('Supplier # required'); return; }
      if(farmsList.some(f=>f.supplier===sup)){
        alert('This supplier already exists'); return;
      }
      const sel=[];
      alarmChkDiv.querySelectorAll('input:checked')
        .forEach(cb=>sel.push(cb.value));
      const newFarm={ supplier:sup,name:nm,activeAlarms:sel };
      farmsList.push(newFarm);
      saveFarms(farmsList);
      renderSummary();
      overviewData = farmsList
        .map(makeOverview)
        .sort((a,b)=>
          ({Critical:3,Warning:2,Info:1,Ok:0}[b.status]
          -({Critical:3,Warning:2,Info:1,Ok:0}[a.status]))
        );
      renderOverview(overviewData);
      formDiv.style.display='none';
      document.getElementById('newSupplier').value='';
      document.getElementById('newFarmName').value='';
    };
  </script>
</body>
</html>