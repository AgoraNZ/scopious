<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dairy Farm Alerts Overview</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --panel-bg: #222;
      --border: #444;
      --text: #f5f5f5;
      --ok: #2ecc71;
      --warning: #f39c12;
      --info: #3498db;
      --critical: #e74c3c;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container {
      max-width: 960px;
      margin: 20px auto;
      padding: 0 16px;
    }
    h1 { margin-bottom: 16px; }

    /* Map button */
    .map-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3498db;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }

    /* Summary */
    .summary { background: var(--panel-bg); border:1px solid var(--border); border-radius:6px; padding:12px; margin-bottom:20px; }
    .summary-row { display:flex; justify-content:space-between; font-size:0.9rem; }
    .summary-row div { flex:1; text-align:center; }

    /* Add‚ÄêFarm form, search, cards, permissions etc‚Ä¶ */
    /* (unchanged from your last working version) */

    /* VAT info */
    .vat-info {
      font-size: 0.85rem;
      color: #ccc;
      text-align: right;
      margin-bottom: 8px;
    }
    .vat-info div { margin: 2px 0; }
  </style>
</head>
<body>
  <!-- Map View button -->
  <button class="map-btn" onclick="location.href='levels-map.html'">
    üìç Map View
  </button>

  <div class="container">
    <h1>Dairy Farm Alerts Overview</h1>

    <!-- Summary -->
    <div class="summary">
      <div class="summary-row">
        <div>All Farms</div>
        <div>Status: Active</div>
        <div>Gateways: <span id="sum-gw"></span></div>
        <div>Devices: <span id="sum-dev"></span></div>
        <div>Active: <span id="sum-act"></span></div>
        <div>Inactive: <span id="sum-inact"></span></div>
      </div>
    </div>

    <!-- (Add‚ÄêFarm form, Search, Permissions toggles as before) -->

    <!-- Card Grid -->
    <div class="cards" id="card-container"></div>

    <!-- (Footer: Create Alarm/Rule button, only for Admin) -->
  </div>

  <script>
    // your existing data + functions...
    const LS_FARMS = 'farms';
    const LS_TICKETS = 'tickets';
    const ALARMS = [/*‚Ä¶*/];
    const historyCfg = { /*‚Ä¶*/ };

    // Load farms, initialize vats if missing
    function loadFarms(){
      let f = JSON.parse(localStorage.getItem(LS_FARMS)||'[]');
      if(!f.length){
        f = Object.keys(historyCfg).map(s=>({ supplier:s, name:'', activeAlarms:[...ALARMS] }));
      }
      let updated = false;
      f.forEach(farm=>{
        if(!Array.isArray(farm.vats)){
          farm.vats = [Math.floor(Math.random()*20000)];
          if(Math.random() < 0.1) farm.vats.push(Math.floor(Math.random()*20000));
          updated = true;
        }
      });
      if(updated) localStorage.setItem(LS_FARMS, JSON.stringify(f));
      return f;
    }
    let farmsList = loadFarms();
    let tickets   = JSON.parse(localStorage.getItem(LS_TICKETS)||'[]');

    // Summary
    function renderSummary(){
      const gw = farmsList.length;
      const dev = gw * 4;
      document.getElementById('sum-gw').textContent = gw;
      document.getElementById('sum-dev').textContent = dev;
      document.getElementById('sum-act').textContent = dev;
      document.getElementById('sum-inact').textContent = 0;
    }
    renderSummary();

    // Build overviewData, renderCards (including VAT info)
    function makeOverview(f){
      const cfg = historyCfg[f.supplier]||{};
      let status='Ok', alarm='', time='';
      if(cfg.criticalOn){ status='Critical'; alarm='temperature fault'; time=cfg.criticalOn; }
      else if(cfg.warningOn){ status='Warning'; alarm='Battery Low Alarm'; time=cfg.warningOn; }
      return {...f, status, alarm, time};
    }
    let overviewData = farmsList.map(makeOverview).sort((a,b)=>{
      const sev={'Critical':3,'Warning':2,'Info':1,'Ok':0};
      return sev[b.status] - sev[a.status];
    });

    function renderCards(rows){
      const c = document.getElementById('card-container');
      c.innerHTML = '';
      rows.forEach(r=>{
        // ticket button logic (unchanged)‚Ä¶
        let ticketHTML = '';
        // ‚Ä¶determine ticketHTML‚Ä¶

        // VAT info HTML
        const vatsHtml = r.vats.map((v,i)=>`<div>Vat ${i+1}: ${v.toLocaleString()} L</div>`).join('');

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <a href="dashboard.html?supplier=${r.supplier}" class="supplier">
              #${r.supplier}
            </a>
            <div class="farm-name">${r.name}</div>
            <div class="vat-info">${vatsHtml}</div>
          </div>
          <div class="card-body">
            <a href="alarm.html?supplier=${r.supplier}">
              <div class="status status-${r.status.toLowerCase()}">
                <span class="dot"></span>${r.status}
              </div>
              <div class="alarm-name">${r.alarm}</div>
              <div class="time">${r.time}</div>
            </a>
          </div>
          <div class="card-actions">
            ${ticketHTML}
            <!-- edit button for Admin only, etc‚Ä¶ -->
          </div>
        `;
        c.appendChild(card);
      });
    }
    renderCards(overviewData);

    // ‚Ä¶rest of your existing event-handlers (search, add-farm, permissions toggle)‚Ä¶
  </script>
</body>
</html>
