<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dairy Farm Alerts Overview</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --panel-bg: #222;
      --border: #444;
      --text: #f5f5f5;
      --ok: #2ecc71;
      --warning: #f39c12;
      --info: #3498db;
      --critical: #e74c3c;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin:0; font-family:sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container {
      max-width:960px; margin:20px auto; padding:0 16px;
    }
    h1 { margin-bottom:16px; }

    /* Map button */
    .map-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #3498db;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1000;
    }

    /* Summary */
    .summary {
      background:var(--panel-bg);
      border:1px solid var(--border);
      border-radius:6px;
      padding:12px; margin-bottom:20px;
    }
    .summary-row {
      display:flex; justify-content:space-between;
      font-size:0.9rem;
    }
    .summary-row div { flex:1; text-align:center; }

    /* Add Farm */
    .add-farm-btn { margin-bottom:12px; text-align:right; }
    .add-farm-btn button {
      padding:8px 12px; background:#3498db;
      border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }
    #addFarmForm {
      display:none; background:var(--panel-bg);
      border:1px solid var(--border);
      border-radius:6px; padding:12px; margin-bottom:16px;
    }
    #addFarmForm label {
      display:block; margin-bottom:8px; font-size:0.9rem;
    }
    #addFarmForm input[type="text"] {
      width:100%; padding:6px; border:1px solid #555;
      border-radius:4px; background:#333; color:var(--text);
    }
    .alarms-list {
      display:grid; grid-template-columns:1fr 1fr;
      gap:4px; margin:12px 0;
    }
    .alarms-list label {
      display:flex; align-items:center; font-size:0.9rem;
    }
    .alarms-list input { margin-right:6px; }
    #addFarmForm .buttons {
      text-align:right; margin-top:8px;
    }
    #addFarmForm .buttons button {
      padding:6px 10px; border:none; border-radius:4px;
      background:#3498db; color:#fff; cursor:pointer;
      margin-left:8px;
    }

    /* Search */
    .search { margin-bottom:16px; }
    .search input {
      width:100%; padding:8px 12px;
      border:none; border-radius:4px;
      background:#2c2c2c; color:var(--text);
      font-size:0.95rem;
    }

    /* Vat info */
    .vat-info {
      font-size:0.85rem; color:#ccc;
      text-align:right; margin-bottom:8px;
    }
    .vat-info div { margin:2px 0; }

    /* Card grid */
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:16px;
    }
    .card {
      background:var(--panel-bg);
      border:1px solid var(--border);
      border-radius:6px;
      display:flex; flex-direction:column;
      padding:16px;
    }
    .card-header {
      margin-bottom:8px;
    }
    .card-header .supplier {
      font-weight:bold;
      color:var(--text);
      text-decoration:none;
      font-size:1rem;
    }
    .card-header .farm-name {
      color:#bbb; font-size:0.9rem;
    }
    .card-body {
      flex:1; margin-bottom:12px;
    }
    .card-body a {
      text-decoration:none; color:inherit;
    }
    .status {
      display:inline-flex; align-items:center;
      font-size:0.9rem; padding:4px 8px;
      border-radius:4px; color:#fff;
      margin-bottom:8px;
    }
    .status-ok       { background:var(--ok); }
    .status-warning  { background:var(--warning); }
    .status-info     { background:var(--info); }
    .status-critical { background:var(--critical); }
    .status .dot {
      width:10px; height:10px; border-radius:50%;
      background:currentColor; margin-right:6px;
    }
    .alarm-name, .time {
      font-size:0.85rem; color:#ccc;
      margin-bottom:4px;
    }
    .card-actions {
      display:flex; gap:8px;
    }
    .card-actions button {
      flex:1; padding:6px 8px; font-size:0.9rem;
      border:none; border-radius:4px; cursor:pointer;
    }
    .btn-ticket { background:var(--critical); color:#fff; }
    .btn-edit   { background:#3498db; color:#fff; }

    /* Permissions */
    .permissions {
      margin:24px 0; text-align:center; font-size:0.9rem;
    }
    .permissions label {
      margin:0 12px; cursor:pointer;
    }
    .permissions input {
      margin-right:4px;
    }

    /* Footer */
    .footer-btn {
      text-align:center; margin-bottom:24px;
    }
    .footer-btn button {
      padding:10px 20px; font-size:1rem;
      background:#3498db; color:#fff;
      border:none; border-radius:4px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- Map View -->
  <button class="map-btn" onclick="location.href='levels-map.html'">
    üìç Map View
  </button>

  <div class="container">
    <h1>Dairy Farm Alerts Overview</h1>

    <!-- Summary -->
    <div class="summary">
      <div class="summary-row">
        <div>All Farms</div>
        <div>Status: Active</div>
        <div>Gateways: <span id="sum-gw"></span></div>
        <div>Devices: <span id="sum-dev"></span></div>
        <div>Active: <span id="sum-act"></span></div>
        <div>Inactive: <span id="sum-inact"></span></div>
      </div>
    </div>

    <!-- Add Farm -->
    <div class="add-farm-btn">
      <button id="showAddForm">+ Add Farm</button>
    </div>
    <div id="addFarmForm">
      <label>Supplier #:
        <input type="text" id="newSupplier" placeholder="e.g. 12345"/>
      </label>
      <label>Farm Name:
        <input type="text" id="newFarmName" placeholder="e.g. J Block"/>
      </label>
      <div>Assign Alarms:</div>
      <div class="alarms-list" id="alarmsCheckboxes"></div>
      <div class="buttons">
        <button id="cancelAdd">Cancel</button>
        <button id="saveAdd">Save</button>
      </div>
    </div>

    <!-- Search -->
    <div class="search">
      <input id="search" placeholder="üîç Filter by supplier number‚Ä¶"/>
    </div>

    <!-- Cards -->
    <div class="cards" id="card-container"></div>

    <!-- Permissions -->
    <div class="permissions">
      <label><input type="radio" name="role" value="admin" checked> Admin</label>
      <label><input type="radio" name="role" value="service"> Service</label>
      <label><input type="radio" name="role" value="processor"> Processor</label>
    </div>

    <!-- Create Rule -->
    <div class="footer-btn">
      <button onclick="location.href='rules.html'">Create Alarm / Rule</button>
    </div>
  </div>

  <script>
    const ALARMS = [
      'Milk Collection','Plate Cooler Fault',
      'Vat Chiller Compressor Fault','Agitator Fault',
      'Vat Hot Wash','Battery Low Alarm',
      'Chiller Condition','temperature fault'
    ];
    const historyCfg = {
      '12345':{criticalOn:null,warningOn:null},
      '52440':{criticalOn:null,warningOn:null},
      '44074':{criticalOn:'2025-05-06 05:39',warningOn:null},
      '35421':{criticalOn:null,warningOn:null},
      '98765':{criticalOn:null,warningOn:'2025-05-04 10:30'},
      '24680':{criticalOn:null,warningOn:null},
      '13579':{criticalOn:null,warningOn:null},
      '11223':{criticalOn:null,warningOn:null},
      '99887':{criticalOn:'2025-04-30 12:50',warningOn:null},
      '55678':{criticalOn:null,warningOn:null}
    };
    const LS_FARMS   = 'farms';
    const LS_TICKETS = 'tickets';
    let currentRole = 'admin';

    // Load farms & init vats
    function loadFarms(){
      let f = JSON.parse(localStorage.getItem(LS_FARMS)||'null');
      if(!f){
        f = Object.keys(historyCfg).map(s=>({
          supplier:s,name:'',activeAlarms:[...ALARMS]
        }));
      }
      let changed = false;
      f.forEach(farm=>{
        if(!Array.isArray(farm.vats)){
          farm.vats = [Math.floor(Math.random()*20000)];
          if(Math.random()<0.1) farm.vats.push(Math.floor(Math.random()*20000));
          changed = true;
        }
      });
      if(changed) localStorage.setItem(LS_FARMS, JSON.stringify(f));
      return f;
    }
    function saveFarms(arr){
      localStorage.setItem(LS_FARMS, JSON.stringify(arr));
    }
    function loadTickets(){
      return JSON.parse(localStorage.getItem(LS_TICKETS)||'[]');
    }
    function saveTickets(arr){
      localStorage.setItem(LS_TICKETS, JSON.stringify(arr));
    }

    let farmsList = loadFarms();
    let tickets   = loadTickets();

    // Summary
    function renderSummary(){
      const gw = farmsList.length;
      const dev= gw*4;
      document.getElementById('sum-gw').textContent  = gw;
      document.getElementById('sum-dev').textContent = dev;
      document.getElementById('sum-act').textContent = dev;
      document.getElementById('sum-inact').textContent = 0;
    }
    renderSummary();

    // Build overview data
    function makeOverview(f){
      const cfg = historyCfg[f.supplier]||{};
      let status='Ok', alarm='', time='';
      if(cfg.criticalOn){
        status='Critical'; alarm='temperature fault'; time=cfg.criticalOn;
      } else if(cfg.warningOn){
        status='Warning'; alarm='Battery Low Alarm'; time=cfg.warningOn;
      }
      return {...f,status,alarm,time};
    }
    let overviewData = farmsList
      .map(makeOverview)
      .sort((a,b)=>{
        const sev={'Critical':3,'Warning':2,'Info':1,'Ok':0};
        return sev[b.status]-sev[a.status];
      });

    // Render cards (with VAT info & map links)
    function renderCards(rows){
      const c = document.getElementById('card-container');
      c.innerHTML = '';
      rows.forEach(r=>{
        const tk = tickets.find(t=>
          t.supplier===r.supplier && t.alertTime===r.time
        );
        let ticketHTML = '';
        if(r.status==='Critical' && (currentRole==='admin'||currentRole==='service')){
          if(!tk){
            ticketHTML = `<button class="btn-ticket" onclick="
              location.href='ticket.html?\
supplier=${r.supplier}&alertTime=${encodeURIComponent(r.time)}'
            ">Open Ticket</button>`;
          } else if(!tk.closeTime){
            ticketHTML = `<button class="btn-ticket" onclick="
              location.href='ticket.html?\
supplier=${r.supplier}&alertTime=${encodeURIComponent(r.time)}'
            ">View Ticket</button>`;
          } else {
            ticketHTML = `<div>Closed: ${tk.closeTime}</div>`;
          }
        } else if(r.status==='Critical' && currentRole==='processor'){
          ticketHTML = tk
            ? (tk.closeTime
                ? `Closed: ${tk.closeTime}`
                : 'Open')
            : '';
        }
        // VAT info
        const vatsHtml = r.vats.map((v,i)=>
          `<div>Vat ${i+1}: ${v.toLocaleString()} L</div>`
        ).join('');
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <a href="dashboard.html?supplier=${r.supplier}" class="supplier">
              #${r.supplier}
            </a>
            <div class="farm-name">${r.name}</div>
            <div class="vat-info">${vatsHtml}</div>
          </div>
          <div class="card-body">
            <a href="alarm.html?supplier=${r.supplier}">
              <div class="status status-${r.status.toLowerCase()}">
                <span class="dot"></span>${r.status}
              </div>
              <div class="alarm-name">${r.alarm}</div>
              <div class="time">${r.time}</div>
            </a>
          </div>
          <div class="card-actions">
            ${ticketHTML}
            ${currentRole==='admin'
              ? `<button class="btn-edit" onclick="
                  location.href='setup.html?\
supplier=${r.supplier}'"
                >Edit</button>`
              : ''}
          </div>
        `;
        c.appendChild(card);
      });
    }
    renderCards(overviewData);

    // Permissions toggle
    function updatePermissions(){
      document.getElementById('showAddForm').style.display =
        currentRole==='admin' ? 'inline-block' : 'none';
      document.getElementById('addFarmForm').style.display = 'none';
      document.querySelector('.footer-btn').style.display =
        currentRole==='admin' ? 'block' : 'none';
      renderCards(overviewData);
    }
    document.querySelectorAll('input[name="role"]').forEach(radio=>{
      radio.addEventListener('change', e=>{
        currentRole = e.target.value;
        updatePermissions();
      });
    });
    updatePermissions();

    // Search filter
    document.getElementById('search')
      .addEventListener('input', e=>{
        const q = e.target.value.trim();
        renderCards(overviewData.filter(r=>r.supplier.includes(q)));
      });

    // Add Farm form logic
    const showBtn     = document.getElementById('showAddForm');
    const formDiv     = document.getElementById('addFarmForm');
    const cancelBtn   = document.getElementById('cancelAdd');
    const saveBtn     = document.getElementById('saveAdd');
    const alarmChkDiv = document.getElementById('alarmsCheckboxes');

    showBtn.onclick = ()=>{
      formDiv.style.display = 'block';
      alarmChkDiv.innerHTML = '';
      ALARMS.forEach(name=>{
        const id = `chk_${name.replace(/\s+/g,'')}`;
        alarmChkDiv.innerHTML += `
          <label>
            <input type="checkbox" id="${id}"
                   value="${name}" checked/> ${name}
          </label>`;
      });
    };
    cancelBtn.onclick = ()=> formDiv.style.display='none';

    saveBtn.onclick = ()=>{
      const sup = document.getElementById('newSupplier').value.trim();
      const nm  = document.getElementById('newFarmName').value.trim();
      if(!sup){ alert('Supplier # required'); return; }
      if(farmsList.some(f=>f.supplier===sup)){
        alert('Already exists'); return;
      }
      const sel=[];
      alarmChkDiv.querySelectorAll('input:checked')
        .forEach(cb=>sel.push(cb.value));
      const newFarm={supplier:sup,name:nm,activeAlarms:sel};
      farmsList.push(newFarm);
      saveFarms(farmsList);
      renderSummary();
      overviewData = farmsList
        .map(makeOverview)
        .sort((a,b)=>{
          const sev={'Critical':3,'Warning':2,'Info':1,'Ok':0};
          return sev[b.status]-sev[a.status];
        });
      renderCards(overviewData);
      formDiv.style.display='none';
      document.getElementById('newSupplier').value='';
      document.getElementById('newFarmName').value='';
    };
  </script>
</body>
</html>
