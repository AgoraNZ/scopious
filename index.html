<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dairy Farm Alerts Overview</title>
  <style>
    :root {
      --bg: #1e1e1e;
      --header-bg: #2c2c2c;
      --row-hover: #333;
      --text: #f5f5f5;
      --ok: #2ecc71;
      --warning: #f39c12;
      --info: #3498db;
      --critical: #e74c3c;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family:sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container {
      max-width:960px; margin:20px auto; padding:0 16px;
    }
    h1 { margin-bottom:12px; }
    .search, .add-farm-btn {
      margin-bottom:12px;
    }
    .search input {
      width:100%; padding:8px 12px;
      border:none; border-radius:4px;
      background:#2c2c2c; color:var(--text);
    }
    .add-farm-btn button {
      padding:8px 12px; background:#3498db;
      border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }
    #addFarmForm {
      background:#222; border:1px solid #444;
      padding:12px; border-radius:6px;
      margin-bottom:16px;
    }
    #addFarmForm input[type="text"],
    #addFarmForm label {
      display:block; color:var(--text);
      margin-bottom:6px;
    }
    #addFarmForm input[type="text"] {
      width:100%; padding:6px; border-radius:4px;
      border:1px solid #555; background:#333; color:var(--text);
    }
    #addFarmForm .alarms-list {
      display:grid; grid-template-columns:1fr 1fr;
      gap:4px;
      margin-bottom:12px;
    }
    #addFarmForm .alarms-list label {
      display:flex; align-items:center;
      font-size:0.9rem;
    }
    #addFarmForm .alarms-list input {
      margin-right:6px;
    }
    #addFarmForm .buttons {
      text-align:right;
    }
    #addFarmForm .buttons button {
      padding:6px 10px; margin-left:8px;
      border:none; border-radius:4px; cursor:pointer;
    }
    table {
      width:100%; border-collapse:collapse;
    }
    thead { background:var(--header-bg); }
    th, td {
      padding:10px; text-align:left;
      font-size:0.95rem; color:var(--text);
      border-bottom:1px solid #444;
    }
    tbody tr:hover { background:var(--row-hover); }
    .dot {
      display:inline-block; width:10px; height:10px;
      border-radius:50%; margin-right:6px;
      vertical-align:middle;
    }
    .status-ok       .dot { background:var(--ok); }
    .status-warning  .dot { background:var(--warning); }
    .status-info     .dot { background:var(--info); }
    .status-critical .dot { background:var(--critical); }
    table a {
      color:var(--text)!important; text-decoration:none;
      display:block; width:100%; height:100%;
    }
    td.comment { min-width:120px; }
    td.actions button {
      padding:4px 8px; background:#3498db;
      border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }
    .footer-btn { text-align:center; margin-top:20px; }
    .footer-btn button {
      padding:10px 20px; font-size:1rem;
      border:none; border-radius:4px;
      background:#3498db; color:#fff;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dairy Farm Alerts Overview</h1>

    <div class="add-farm-btn">
      <button id="showAddForm">Add Farm</button>
    </div>

    <div id="addFarmForm" style="display:none;">
      <label>Supplier Number:
        <input type="text" id="newSupplier" placeholder="e.g. 12345"/>
      </label>
      <label>Farm Name:
        <input type="text" id="newFarmName" placeholder="e.g. J Block"/>
      </label>
      <div>
        <span>Assign Alarms:</span>
        <div class="alarms-list" id="alarmsCheckboxes">
          <!-- populated by JS -->
        </div>
      </div>
      <div class="buttons">
        <button id="cancelAdd">Cancel</button>
        <button id="saveAdd">Save</button>
      </div>
    </div>

    <div class="search">
      <input id="search" placeholder="🔍 Filter by supplier number…"/>
    </div>

    <table>
      <thead>
        <tr>
          <th>Supplier #</th>
          <th>Farm Name</th>
          <th>Status</th>
          <th>Alarm Name</th>
          <th>Time Triggered</th>
          <th>Comments</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="overview-body"></tbody>
    </table>

    <div class="footer-btn">
      <button onclick="location.href='rules.html'">Create Alarm / Rule</button>
    </div>
  </div>

  <script>
    // alarm names
    const ALARMS = [
      'Milk Collection',
      'Plate Cooler Fault',
      'Vat Chiller Compressor Fault',
      'Agitator Fault',
      'Vat Hot Wash',
      'Battery Low Alarm',
      'Chiller Condition',
      'temperature fault'
    ];

    // initial historyCfg (unchanged)
    const historyCfg = {
      '12345': { criticalOn:null,              warningOn:null },
      '52440': { criticalOn:null,              warningOn:null },
      '44074': { criticalOn:'2025-05-06 05:39', warningOn:null },
      '35421': { criticalOn:null,              warningOn:null },
      '98765': { criticalOn:null,              warningOn:'2025-05-04 10:30' },
      '24680': { criticalOn:null,              warningOn:null },
      '13579': { criticalOn:null,              warningOn:null },
      '11223': { criticalOn:null,              warningOn:null },
      '99887': { criticalOn:'2025-04-30 12:50', warningOn:null },
      '55678': { criticalOn:null,              warningOn:null }
    };

    // localStorage key
    const LS_FARMS = 'farms';

    // load or init farms list
    function loadFarms(){
      let farms = JSON.parse(localStorage.getItem(LS_FARMS)||'null');
      if(!farms){
        farms = Object.keys(historyCfg).map(s => ({
          supplier:s,
          name:'',
          activeAlarms:[...ALARMS]
        }));
        localStorage.setItem(LS_FARMS, JSON.stringify(farms));
      }
      return farms;
    }

    function saveFarms(farms){
      localStorage.setItem(LS_FARMS, JSON.stringify(farms));
    }

    let farmsList = loadFarms();

    // build overview row
    function makeOverview(f){
      const cfg = historyCfg[f.supplier]||{};
      let status='Ok', alarmName='', time='', comment='';
      if(cfg.criticalOn){
        status='Critical'; alarmName='temperature fault';
        time=cfg.criticalOn; comment='Immediate attention required';
      } else if(cfg.warningOn){
        status='Warning'; alarmName='Battery Low Alarm';
        time=cfg.warningOn;
      }
      return {...f, status, alarmName, time, comment};
    }

    // full data
    let overviewData = farmsList.map(makeOverview)
      .sort((a,b)=>{
        const sev={Critical:3,Warning:2,Info:1,Ok:0};
        return sev[b.status] - sev[a.status];
      });

    // render table
    function renderOverview(rows){
      const tb = document.getElementById('overview-body');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const editable = r.status==='Critical'?'contenteditable':'';
        tr.innerHTML = `
          <td>${r.supplier}</td>
          <td>${r.name}</td>
          <td class="status-${r.status.toLowerCase()}">
            <a href="alarm.html?supplier=${r.supplier}">
              <span class="dot"></span>${r.status}
            </a>
          </td>
          <td><a href="alarm.html?supplier=${r.supplier}">${r.alarmName}</a></td>
          <td><a href="alarm.html?supplier=${r.supplier}">${r.time}</a></td>
          <td class="comment" ${editable}>${r.comment}</td>
          <td class="actions">
            <button onclick="location.href='setup.html?supplier=${r.supplier}'">Edit</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
    renderOverview(overviewData);

    // live search
    document.getElementById('search')
      .addEventListener('input', e=>{
        const q=e.target.value.trim();
        renderOverview(
          overviewData.filter(r=>r.supplier.includes(q))
        );
      });

    // Add Farm form logic
    const showBtn = document.getElementById('showAddForm');
    const formDiv = document.getElementById('addFarmForm');
    const cancelBtn = document.getElementById('cancelAdd');
    const saveBtn = document.getElementById('saveAdd');
    const alarmChkDiv = document.getElementById('alarmsCheckboxes');

    showBtn.onclick = ()=>{
      formDiv.style.display='block';
      // populate checkboxes
      alarmChkDiv.innerHTML = '';
      ALARMS.forEach(name=>{
        const id = `chk_${name.replace(/\s+/g,'')}`;
        alarmChkDiv.innerHTML += `
          <label>
            <input type="checkbox" id="${id}" value="${name}" checked/>
            ${name}
          </label>
        `;
      });
    };
    cancelBtn.onclick = ()=> formDiv.style.display='none';

    saveBtn.onclick = ()=>{
      const sup = document.getElementById('newSupplier').value.trim();
      const nm  = document.getElementById('newFarmName').value.trim();
      if(!sup){ alert('Supplier # required'); return; }
      if(farmsList.some(f=>f.supplier===sup)){ alert('Already exists'); return; }
      const selected = [];
      alarmChkDiv.querySelectorAll('input[type=checkbox]:checked')
        .forEach(cb=> selected.push(cb.value));
      const newFarm = { supplier:sup, name:nm, activeAlarms:selected };
      farmsList.push(newFarm);
      saveFarms(farmsList);
      overviewData = farmsList.map(makeOverview)
        .sort((a,b)=>({Critical:3,Warning:2,Info:1,Ok:0}[b.status] - {Critical:3,Warning:2,Info:1,Ok:0}[a.status]));
      renderOverview(overviewData);
      formDiv.style.display='none';
      document.getElementById('newSupplier').value='';
      document.getElementById('newFarmName').value='';
    };
  </script>
</body>
</html>
